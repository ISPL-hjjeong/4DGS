# 6개 평면 생성 과정 상세 설명

## 🎯 목표
4D 공간(x, y, z, t)에서 6개의 2D 평면(xy, yz, xz, xt, yt, zt)을 어떻게 생성하는지 단계별로 설명

---

## 📋 기본 개념

### 4D 공간의 차원 인덱스
```python
차원 인덱스: 0 = x, 1 = y, 2 = z, 3 = t
```

### 조합(Combination)의 개념
- **4개 차원에서 2개씩 선택**하는 모든 방법
- 수학적으로: C(4,2) = 4!/(2!×2!) = **6개**

---

## 🔍 단계별 생성 과정

### **1단계: 조합 생성**

```python
import itertools

# 4개 차원에서 2개씩 선택하는 모든 조합
coo_combs = list(itertools.combinations(range(4), 2))
```

**무엇을 하는가?**
- `range(4)` = `[0, 1, 2, 3]` (x, y, z, t의 인덱스)
- `combinations(..., 2)` = 2개씩 선택하는 모든 조합

**결과:**
```python
coo_combs = [
    (0, 1),  # x와 y → xy 평면
    (0, 2),  # x와 z → xz 평면
    (0, 3),  # x와 t → xt 평면
    (1, 2),  # y와 z → yz 평면
    (1, 3),  # y와 t → yt 평면
    (2, 3)   # z와 t → zt 평면
]
```

**시각화:**
```
4개 차원: [x, y, z, t]
인덱스:   [0, 1, 2, 3]

조합 생성:
(0,1) → x와 y → xy 평면
(0,2) → x와 z → xz 평면
(0,3) → x와 t → xt 평면
(1,2) → y와 z → yz 평면
(1,3) → y와 t → yt 평면
(2,3) → z와 t → zt 평면
```

---

### **2단계: 각 조합마다 평면 생성**

```python
# 해상도 설정 (예시)
reso = [64, 64, 64, 25]  # [res_x, res_y, res_z, res_t]
out_dim = 32  # feature 차원

# 각 조합마다 반복
for ci, coo_comb in enumerate(coo_combs):
    # 평면 파라미터 생성
    new_grid_coef = nn.Parameter(torch.empty(
        [1, out_dim] + [reso[cc] for cc in coo_comb[::-1]]
    ))
```

---

### **3단계: 각 평면의 Shape 결정**

#### **평면 1: xy 평면 (coo_comb = (0, 1))**

```python
coo_comb = (0, 1)  # x와 y
coo_comb[::-1] = (1, 0)  # 역순: y와 x

# 해상도 가져오기
reso[1] = 64  # y축 해상도
reso[0] = 64  # x축 해상도

# Shape 생성
shape = [1, 32] + [64, 64]
      = [1, 32, 64, 64]

# 의미: 32차원 feature가 있는 64×64 그리드
```

**시각화:**
```
xy 평면:
- x축: 64개 그리드 포인트 (0~63)
- y축: 64개 그리드 포인트 (0~63)
- 각 (x, y) 위치마다: 32차원 feature
- 총 그리드 포인트: 64 × 64 = 4,096개
- 총 파라미터: 4,096 × 32 = 131,072개
```

---

#### **평면 2: xz 평면 (coo_comb = (0, 2))**

```python
coo_comb = (0, 2)  # x와 z
coo_comb[::-1] = (2, 0)  # 역순: z와 x

# 해상도 가져오기
reso[2] = 64  # z축 해상도
reso[0] = 64  # x축 해상도

# Shape 생성
shape = [1, 32] + [64, 64]
      = [1, 32, 64, 64]

# 의미: 32차원 feature가 있는 64×64 그리드
```

**시각화:**
```
xz 평면:
- x축: 64개 그리드 포인트 (0~63)
- z축: 64개 그리드 포인트 (0~63)
- 각 (x, z) 위치마다: 32차원 feature
- 총 그리드 포인트: 64 × 64 = 4,096개
- 총 파라미터: 4,096 × 32 = 131,072개
```

---

#### **평면 3: xt 평면 (coo_comb = (0, 3))**

```python
coo_comb = (0, 3)  # x와 t
coo_comb[::-1] = (3, 0)  # 역순: t와 x

# 해상도 가져오기
reso[3] = 25  # t축 해상도 (시간은 고정!)
reso[0] = 64  # x축 해상도

# Shape 생성
shape = [1, 32] + [25, 64]
      = [1, 32, 25, 64]

# 의미: 32차원 feature가 있는 25×64 그리드
```

**시각화:**
```
xt 평면:
- x축: 64개 그리드 포인트 (0~63)
- t축: 25개 그리드 포인트 (0~24) ← 시간은 고정!
- 각 (x, t) 위치마다: 32차원 feature
- 총 그리드 포인트: 25 × 64 = 1,600개
- 총 파라미터: 1,600 × 32 = 51,200개
```

---

#### **평면 4: yz 평면 (coo_comb = (1, 2))**

```python
coo_comb = (1, 2)  # y와 z
coo_comb[::-1] = (2, 1)  # 역순: z와 y

# 해상도 가져오기
reso[2] = 64  # z축 해상도
reso[1] = 64  # y축 해상도

# Shape 생성
shape = [1, 32] + [64, 64]
      = [1, 32, 64, 64]

# 의미: 32차원 feature가 있는 64×64 그리드
```

---

#### **평면 5: yt 평면 (coo_comb = (1, 3))**

```python
coo_comb = (1, 3)  # y와 t
coo_comb[::-1] = (3, 1)  # 역순: t와 y

# 해상도 가져오기
reso[3] = 25  # t축 해상도 (시간은 고정!)
reso[1] = 64  # y축 해상도

# Shape 생성
shape = [1, 32] + [25, 64]
      = [1, 32, 25, 64]

# 의미: 32차원 feature가 있는 25×64 그리드
```

---

#### **평면 6: zt 평면 (coo_comb = (2, 3))**

```python
coo_comb = (2, 3)  # z와 t
coo_comb[::-1] = (3, 2)  # 역순: t와 z

# 해상도 가져오기
reso[3] = 25  # t축 해상도 (시간은 고정!)
reso[2] = 64  # z축 해상도

# Shape 생성
shape = [1, 32] + [25, 64]
      = [1, 32, 25, 64]

# 의미: 32차원 feature가 있는 25×64 그리드
```

---

## 📊 전체 평면 요약 (해상도 레벨 1, reso=[64, 64, 64, 25])

| 평면 | coo_comb | Shape | 그리드 크기 | 파라미터 수 |
|------|----------|-------|------------|------------|
| **xy** | (0, 1) | `[1, 32, 64, 64]` | 64×64 | 131,072 |
| **xz** | (0, 2) | `[1, 32, 64, 64]` | 64×64 | 131,072 |
| **xt** | (0, 3) | `[1, 32, 25, 64]` | 25×64 | 51,200 |
| **yz** | (1, 2) | `[1, 32, 64, 64]` | 64×64 | 131,072 |
| **yt** | (1, 3) | `[1, 32, 25, 64]` | 25×64 | 51,200 |
| **zt** | (2, 3) | `[1, 32, 25, 64]` | 25×64 | 51,200 |

**총 파라미터 수 (6개 평면 합계):**
- 공간 평면 (xy, xz, yz): 3 × 131,072 = 393,216
- 시간 평면 (xt, yt, zt): 3 × 51,200 = 153,600
- **총합**: 546,816개 파라미터

---

## 🔑 핵심 포인트

### 1. **조합 생성**
- `itertools.combinations(range(4), 2)` → 6개 조합
- 각 조합은 2개의 차원 인덱스

### 2. **Shape 결정**
- `[1, out_dim] + [reso[cc] for cc in coo_comb[::-1]]`
- `coo_comb[::-1]`을 사용하는 이유: `grid_sample`이 (height, width) 순서를 기대

### 3. **시간 차원의 특수성**
- 시간 차원(t, 인덱스 3)은 항상 25로 고정
- 공간 차원(x, y, z)은 해상도 레벨에 따라 증가 (64, 128, 256, 512...)

### 4. **초기화 방식**
- **공간 평면** (xy, xz, yz): `uniform(0.1, 0.5)` 초기화
- **시간 평면** (xt, yt, zt): `ones()` 초기화 (1.0으로 채움)

---

## 💡 실제 코드 흐름

```python
# 1. 해상도 설정
reso = [64, 64, 64, 25]  # [x, y, z, t]
out_dim = 32

# 2. 조합 생성
coo_combs = [(0,1), (0,2), (0,3), (1,2), (1,3), (2,3)]

# 3. 각 조합마다 평면 생성
grid_coefs = nn.ParameterList()
for ci, coo_comb in enumerate(coo_combs):
    # Shape 결정
    shape = [1, 32] + [reso[cc] for cc in coo_comb[::-1]]
    
    # 파라미터 생성 (빈 텐서)
    new_grid_coef = nn.Parameter(torch.empty(shape))
    
    # 초기화
    if 3 in coo_comb:  # 시간 평면
        nn.init.ones_(new_grid_coef)
    else:  # 공간 평면
        nn.init.uniform_(new_grid_coef, 0.1, 0.5)
    
    # 리스트에 추가
    grid_coefs.append(new_grid_coef)

# 결과: grid_coefs는 6개 평면을 포함
# grid_coefs[0]: xy 평면 [1, 32, 64, 64]
# grid_coefs[1]: xz 평면 [1, 32, 64, 64]
# grid_coefs[2]: xt 평면 [1, 32, 25, 64]
# grid_coefs[3]: yz 평면 [1, 32, 64, 64]
# grid_coefs[4]: yt 평면 [1, 32, 25, 64]
# grid_coefs[5]: zt 평면 [1, 32, 25, 64]
```

---

## 🎨 시각적 이해

### 3D 공간에서의 평면

```
        z
        |
        |
        |________ y
       /
      /
     x

xy 평면: 바닥면 (x-y 평면)
xz 평면: 옆면 (x-z 평면)
yz 평면: 앞면 (y-z 평면)
```

### 4D 공간에서의 평면 (시간 포함)

```
공간 평면 (3개):
- xy: 공간의 바닥면
- xz: 공간의 옆면
- yz: 공간의 앞면

시간 평면 (3개):
- xt: x축과 시간축의 조합
- yt: y축과 시간축의 조합
- zt: z축과 시간축의 조합
```

---

## ❓ 자주 묻는 질문

### Q1: 왜 `coo_comb[::-1]`을 사용하나요?
**A:** `grid_sample` 함수가 (height, width) 순서를 기대하기 때문입니다. 
- `coo_comb = (0, 1)` → `coo_comb[::-1] = (1, 0)` → `[reso[1], reso[0]]` = `[64, 64]`
- 이는 (y축, x축) 순서로 해석되어 올바른 그리드 shape를 만듭니다.

### Q2: 왜 시간 차원은 25로 고정인가요?
**A:** 시간 프레임 수가 고정되어 있기 때문입니다. 
- 예: 25프레임의 동영상 → t축 해상도 = 25
- 공간은 무한히 세밀하게 할 수 있지만, 시간은 프레임 수에 제한됩니다.

### Q3: 각 평면은 독립적인가요?
**A:** 네, 각 평면은 독립적인 파라미터입니다. 
- 학습 과정에서 각 평면이 서로 다른 정보를 학습합니다.
- 최종적으로는 6개 평면의 feature를 곱셈으로 결합합니다.

---

## 📝 요약

1. **조합 생성**: `itertools.combinations(range(4), 2)` → 6개 조합
2. **평면 생성**: 각 조합마다 2D 그리드 파라미터 생성
3. **Shape 결정**: `[1, 32, reso[axis1], reso[axis2]]`
4. **초기화**: 공간 평면은 uniform, 시간 평면은 ones
5. **결과**: 6개의 독립적인 2D 평면 그리드

이 6개 평면이 HexPlane의 핵심입니다! 🎯

